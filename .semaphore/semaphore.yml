version: v1.0
name: Dynein walk
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: "Configure environment"
    task:
      jobs:
      - name: Install requirements
        commands:
          - sudo apt-get update
          - sudo apt-get -y install apt-utils time
          - sudo apt-get -y install texlive-latex-extra texlive-xetex texlive-full python3-matplotlib python-matplotlib g++ git inkscape make dvipng
          - curl https://sh.rustup.rs -sSf | sh -s -- -y
          - echo $PATH
          - ln -s ~/.cargo/bin/cargo /usr/local/bin/
          - git clone https://github.com/droundy/fac
          - cd fac && cargo build --release && cp target/release/fac /usr/local/bin/
          - echo "done"

  - name: "Build"
    task:
      jobs:
      - name: Docker build
        commands:
          - checkout
          - fac
          - echo "done"

  - name: "Smoke tests"
    task:
      jobs:
      - name: Smoke
        commands:
          - checkout
          - echo "make smoke"

  - name: "Unit tests"
    task:
      jobs:
      - name: RSpec
        commands:
          - checkout
          - echo "make rspec"

      - name: Lint code
        commands:
          - checkout
          - echo "make lint"

      - name: Check security
        commands:
          - checkout
          - echo "make security"

  - name: "Integration tests"
    task:
      jobs:
      - name: Cucumber
        commands:
          - checkout
          - echo "make cucumber"

  - name: "Push Image"
    task:
      jobs:
      - name: Push
        commands:
          - checkout
          - echo "make docker.push"
